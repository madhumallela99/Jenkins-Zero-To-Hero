pipeline {
  agent any

  environment {
    IMAGE_NAME = "madhumallela/springboot"
    IMAGE_TAG  = "${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/YOUR-ORG/springboot-gitops.git'
      }
    }

    stage('Build JAR') {
      steps {
        sh 'mvn clean package -DskipTests'
      }
    }

    stage('Build & Push Image') {
      steps {
        sh '''
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG
        '''
      }
    }

    stage('Update GitOps Manifest') {
      steps {
        sh '''
          sed -i "s|image:.*|image: $IMAGE_NAME:$IMAGE_TAG|" k8s/deployment.yaml
          git add k8s/deployment.yaml
          git commit -m "Update image to $IMAGE_TAG"
          git push origin main
        '''
      }
    }
  }
}
